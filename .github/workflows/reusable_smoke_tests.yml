name: Reusable Smoke Test

on:
  workflow_call:
    inputs:
      arch:
        type: string
        description: "Architecture to build the image for (amd64/arm64)"
        required: true
      next_version:
        type: string
        required: false
        description: "Version (x.y.z), daily build date (YYYYMMDD), or URL to Docker image: Default - latest daily build"
      last_version:
        type: string
        required: false
        description: "Version (x.y.z), daily build date (YYYYMMDD), or URL to Docker image: Default - latest release"
      malloc:
        type: boolean
        default: false
        description: "Used if next_type or last_type is of 'date'"

env:
  MEMGRAPH_ENTERPRISE_LICENSE: ${{ secrets.MEMGRAPH_ENTERPRISE_LICENSE }}
  MEMGRAPH_ORGANIZATION_NAME: ${{ secrets.MEMGRAPH_ORGANIZATION_NAME }}

jobs:
  smoke-test-image:
    runs-on: ${{ (inputs.arch == 'arm64') && fromJSON('["self-hosted", "ARM64"]') || fromJSON('["self-hosted", "X64"]') }}
    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Determine Input Types
        run: |
          read next_type next_image < <(python3 smoke-release-testing/workflow_image_setup.py "${{ inputs.next_version }}" "${{ inputs.arch }}" "${{ inputs.malloc }}")
          echo "NEXT_IMAGE=${next_image}" >> $GITHUB_ENV
          echo "NEXT_TYPE=${next_type}" >> $GITHUB_ENV
          read last_type last_image < <(python3 smoke-release-testing/workflow_image_setup.py "${{ inputs.last_version }}" "${{ inputs.arch }}" "${{ inputs.malloc }}")
          echo "LAST_IMAGE=${last_image}" >> $GITHUB_ENV
          echo "LAST_TYPE=${last_type}" >> $GITHUB_ENV

      - name: Build Test Image
        run: |
          docker build -t ubuntu:24.04-dind --file Dockerfile.smoke .

      - name: Run Test Image Container
        run: |
          CONTAINER_NAME="smoketester"
          docker run -d --rm  --privileged \
            --name $CONTAINER_NAME \
            -e container=docker \
            -p 2375:2375 \
            --tmpfs /run \
            --tmpfs /run/lock \
            --tmpfs /tmp \
            -v u24-data:/var/lib/docker \
            -v /sys/fs/cgroup:/sys/fs/cgroup:rw \
            --cgroupns=host \
            ubuntu:24.04-dind
          echo "CONTAINER_NAME=$CONTAINER_NAME" >> $GITHUB_ENV

      - name: Load Next Image (Docker)
        if: ${{ env.NEXT_TYPE == 'docker' }}
        run: |
          docker exec -i \
            -e NEXT_IMAGE="${{ env.NEXT_IMAGE }}" \
            "$CONTAINER_NAME" \
            bash -c 'docker pull "$NEXT_IMAGE"'
          echo "MEMGRAPH_NEXT_DOCKERHUB_IMAGE=${{ env.NEXT_IMAGE }}" >> $GITHUB_ENV

      - name: Load Next Image (URL)
        if: ${{ env.NEXT_TYPE == 'url' }}
        run: |
          #curl -L ${{ env.NEXT_IMAGE }} > next.tar.gz
          #load_output=$(docker load -i next.tar.gz)
          
          docker exec -i \
            -e NEXT_IMAGE="${{ env.NEXT_IMAGE }}" \
            "$CONTAINER_NAME" \
            bash -c 'curl -L "$NEXT_IMAGE" > next.tar.gz'
          
          load_output=$(docker exec -i $CONTAINER_NAME bash -c "docker load -i next.tar.gz")

          # grab each repo:tag, drop the ":latest" one, pick the first real tag
          repo_tag=$(echo "$load_output" \
            | awk -F': ' '/Loaded image:/ {print $2}' \
            | grep -v ':latest$' \
            | head -n1)

          echo "MEMGRAPH_NEXT_DOCKERHUB_IMAGE=${repo_tag}" >> $GITHUB_ENV

      - name: Load Last Image (Docker)
        if: ${{ env.LAST_TYPE == 'docker' }}
        run: |
          docker exec -i \
            -e LAST_IMAGE="${{ env.LAST_IMAGE }}" \
            "$CONTAINER_NAME" \
            bash -c 'docker pull "$LAST_IMAGE"'
          echo "MEMGRAPH_LAST_DOCKERHUB_IMAGE=${{ env.LAST_IMAGE }}" >> $GITHUB_ENV


      - name: Load Last Image (URL)
        if: ${{ env.LAST_TYPE == 'url' }}
        run: |
          #curl -L ${{ env.LAST_IMAGE }} > last.tar.gz
          #load_output=$(docker load -i last.tar.gz)

          docker exec -i \
            -e LAST_IMAGE="${{ env.LAST_IMAGE }}" \
            "$CONTAINER_NAME" \
            bash -c 'curl -L "$LAST_IMAGE" > last.tar.gz'
          
          load_output=$(docker exec -i $CONTAINER_NAME bash -c "docker load -i last.tar.gz")
          
          # grab each repo:tag, drop the ":latest" one, pick the first real tag
          repo_tag=$(echo "$load_output" \
            | awk -F': ' '/Loaded image:/ {print $2}' \
            | grep -v ':latest$' \
            | head -n1)

          echo "MEMGRAPH_LAST_DOCKERHUB_IMAGE=${repo_tag}" >> $GITHUB_ENV


      - name: Init Tests
        run: |
          # cd smoke-release-testing
          # ./init_workflow.bash
          docker exec -i $CONTAINER_NAME \
            bash -c "cd /mage/smoke-release-testing && ./init_workflow.bash"

      - name: Install Python Dependencies
        run: |
          docker exec -i $CONTAINER_NAME \
            bash -c "pip install -r /mage/smoke-release-testing/requirements.txt --break-system-packages"
      
      - name: Run Tests
        run: |
          # cd smoke-release-testing
          # ./test.bash
          docker exec -i -u root \
            -e MEMGRAPH_ENTERPRISE_LICENSE="${{ secrets.MEMGRAPH_ENTERPRISE_LICENSE }}" \
            -e MEMGRAPH_ORGANIZATION_NAME="${{ secrets.MEMGRAPH_ORGANIZATION_NAME }}" \
            -e MEMGRAPH_LAST_DOCKERHUB_IMAGE="$LAST_IMAGE" \
            -e MEMGRAPH_NEXT_DOCKERHUB_IMAGE="$NEXT_IMAGE" \
            "$CONTAINER_NAME" \
            bash -c "cd /mage/smoke-release-testing && ./test.bash"
      
      - name: Stop Container
        if: always()
        run: |
          echo "ðŸ“¢ Stopping $CONTAINER_NAMEâ€¦"
          docker stop "$CONTAINER_NAME" || true

          echo "â³ Waiting on $CONTAINER_NAME to fully exitâ€¦"
          docker wait "$CONTAINER_NAME" || true
          echo "$CONTAINER_NAME has exited."
          
      - name: Remove Image
        if: always()
        run: |
          docker rmi ubuntu:24.04-dind

      # remove these if init script works!
      # - name: Install jq 
      #   run: |
      #     apt-get update
      #     apt-get install -y jq          

      # - name: Setup Go
      #   uses: actions/setup-go@v4
      #   with:
      #     go-version: 'stable'

      # - name: Install kind v0.24.0
      #   run: |
      #     go install sigs.k8s.io/kind@v0.24.0
      #     echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      # - name: Verify kind
      #   run: kind --version

      # - name: Install kubectl
      #   run: |
      #     KUBE_VER=$(curl -L -s https://dl.k8s.io/release/stable.txt)
      #     mkdir -p $HOME/bin
      #     curl -Lo kubectl \
      #       "https://dl.k8s.io/release/${KUBE_VER}/bin/linux/amd64/kubectl"
      #     curl -Lo kubectl.sha256 \
      #       "https://dl.k8s.io/release/${KUBE_VER}/bin/linux/amd64/kubectl.sha256"
      #     echo "$(cat kubectl.sha256)  kubectl" | sha256sum --check
      #     chmod +x kubectl
      #     mv kubectl $HOME/bin/
      #     echo "$HOME/bin" >> $GITHUB_PATH

      # - name: Verify kubectl
      #   run: kubectl version --client

      # - name: Create Kind cluster
      #   run: |
      #     if ! kubectl cluster-info --context kind-kind &>/dev/null; then
      #       kind create cluster --name kind-kind
      #     fi
      #     kubectl get all -A

      # - name: Install Helm
      #   run: |
      #     mkdir -p $HOME/bin
      #     export HELM_INSTALL_DIR=$HOME/bin
      #     curl -fsSL -o get_helm.sh \
      #       https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
      #     chmod +x get_helm.sh
      #     ./get_helm.sh
      #     echo "$HOME/bin" >> $GITHUB_PATH

      # - name: Configure Helm repo
      #   run: |
      #     helm repo add memgraph https://memgraph.github.io/helm-charts
      #     helm repo update
      #     helm repo list

      # - name: Build mgconsole
      #   run: |
      #     if [ ! -d mgconsole.build ]; then
      #       git clone git@github.com:memgraph/mgconsole.git mgconsole.build
      #     fi
      #     cd mgconsole.build
      #     git checkout master
      #     mkdir -p build && cd build
      #     cmake -DCMAKE_RELEASE_TYPE=Release ..
      #     make -j$(nproc)
      #     if [ -x src/mgconsole ]; then
      #       echo "mgconsole built successfully"
      #     else
      #       echo "mgconsole build failed" && exit 1
      #     fi

      # - name: Build mgconsole
      #   run: |
      #     if [ ! -d mgconsole.build ]; then
      #       git clone git@github.com:memgraph/mgconsole.git mgconsole.build
      #     fi
      #     cd mgconsole.build
      #     git checkout master
      #     mkdir -p build && cd build
      #     cmake -DCMAKE_RELEASE_TYPE=Release ..
      #     make -j$(nproc)
      #     if [ -x src/mgconsole ]; then
      #       echo "mgconsole built successfully"
      #     else
      #       echo "mgconsole build failed" && exit 1
      #     fi